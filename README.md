# Install dependencies
npm install

# Bootstrap CDK (one-time)
cdk bootstrap

# Run the deployment
npm run dev



// File: README.md
# Error Analysis App Deployer (Simple EC2 + RDS)

Deploy your error analysis application to AWS EC2 + RDS in private subnets with VPN access.

## What Gets Deployed

- **EC2 Instance**: t3.micro (free tier) running your Docker image
- **RDS PostgreSQL**: t3.micro (free tier) with 20GB storage  
- **Security Groups**: VPN-only access configured
- **Docker Image**: `docker.io/joshcutts/error-analysis-app:latest`

## Prerequisites

1. **AWS CLI configured** with appropriate permissions
2. **CDK CLI installed**: `npm install -g aws-cdk`
3. **Node.js 16+** installed
4. **Existing VPC with VPN access**

## Quick Start

### 1. Clone and Setup
```bash
git clone <this-repo>
cd error-analysis-deployer
npm install
```

### 2. Run Interactive Deployment
```bash
npm run dev
```

### 3. Provide Configuration
The CLI will ask for:
- **App name**: `error-analysis-app`
- **VPC ID**: Your VPC ID (vpc-xxxxxxxxx)
- **Private subnets**: Your private subnet IDs (comma-separated)
- **VPN CIDR**: Your VPN CIDR blocks (e.g., 172.16.0.0/16)
- **OpenAI API Key**: Your OpenAI API key
- **Phoenix API Key**: Your Phoenix API key
- **Phoenix API URL**: Your Phoenix API endpoint

### 4. Access Your App
1. Connect to your VPN
2. Access the EC2 private IP directly: `http://10.0.x.x`
3. No load balancer - direct connection to EC2 instance

## Docker Configuration

The deployed docker-compose.yml:
```yaml
services:
  app:
    image: docker.io/joshcutts/error-analysis-app:latest
    network_mode: host
    environment:
      - DB_HOST=<auto-configured-rds-endpoint>
      - DB_USER=<auto-generated>
      - DB_PASSWORD=<auto-generated>
      - OPEN_API_KEY=<your-input>
      - PHOENIX_API_KEY=<your-input>
      - PHOENIX_API_URL=<your-input>
    restart: always
```

## Access & Management

### Accessing Your App
1. **Connect to VPN**
2. **Direct access**: `http://<ec2-private-ip>`
3. **Health check**: `http://<ec2-private-ip>/health`

### SSH Access (if needed)
```bash
# Use AWS Session Manager (no SSH keys needed)
aws ssm start-session --target <instance-id>

# Check Docker status
sudo docker-compose -f /opt/app/docker-compose.yml ps
sudo docker-compose -f /opt/app/docker-compose.yml logs
```

### Database Access
- **Endpoint**: Auto-configured in docker-compose
- **Credentials**: Auto-generated and stored in AWS Secrets Manager
- **Database name**: `error_analysis`

## Cost Estimate (Free Tier)

- **EC2 t3.micro**: Free for 750 hours/month
- **RDS t3.micro**: Free for 750 hours/month  
- **Storage**: 8GB EC2 + 20GB RDS = Free
- **Data Transfer**: Minimal within VPC
- **Total**: ~$0/month (within free tier limits)

## Cleanup

To destroy your deployment:
```bash
cdk destroy <stack-name>

# Example:
cdk destroy error-analysis-app-stack
```

## Troubleshooting

### App not accessible:
1. Verify VPN connection
2. Check security groups allow your VPN CIDR
3. Confirm instance is running: AWS Console ‚Üí EC2

### Docker issues:
```bash
# SSH to instance via Session Manager
aws ssm start-session --target <instance-id>

# Check Docker status
sudo docker ps
sudo docker-compose -f /opt/app/docker-compose.yml logs
```

### Database connection issues:
1. Check RDS instance is running
2. Verify security groups allow EC2 ‚Üí RDS traffic
3. Check database credentials in `/opt/app/.env`

---

// File: .env.example
# Example environment variables (for reference)
DB_HOST=your-rds-endpoint.amazonaws.com
DB_PORT=5432
DB_USER=appuser
DB_PASSWORD=auto-generated-password
DB_NAME=error_analysis
NODE_ENV=production
DB_SSL=true
PGSSLMODE=require
NODE_TLS_REJECT_UNAUTHORIZED=0
OPEN_API_KEY=sk-your-openai-key
PHOENIX_API_KEY=your-phoenix-key
PHOENIX_API_URL=https://api.phoenix.com

---

// File: test-deployment.sh
#!/bin/bash
# Quick test deployment script

echo "üß™ Testing Error Analysis App Deployment"
echo ""

# Check prerequisites
if ! command -v aws &> /dev/null; then
    echo "‚ùå AWS CLI not found. Please install AWS CLI first."
    exit 1
fi

if ! command -v cdk &> /dev/null; then
    echo "‚ùå CDK CLI not found. Installing..."
    npm install -g aws-cdk
fi

if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js not found. Please install Node.js 16+ first."
    exit 1
fi

echo "‚úÖ Prerequisites check passed"
echo ""

# Install dependencies
echo "üì¶ Installing dependencies..."
npm install

echo ""
echo "üöÄ Starting interactive deployment..."
echo "You will be prompted for:"
echo "  - Your VPC ID"
echo "  - Your private subnet IDs"
echo "  - Your VPN CIDR blocks"
echo "  - API keys (OpenAI and Phoenix)"
echo ""

read -p "Continue? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    npm run dev
else
    echo "Deployment cancelled."
fi